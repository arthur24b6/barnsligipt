/* Original work by Johannes la Poutr√© (http://squio.nl), modified for these purposes */
function hitch(a,b){return function(){a[b].apply(a,arguments)}}function ExifException(a){this.message=a,this.name="ExifException",this.toString=function(){return this.message}}function ExifProcessor(a){this.dataSource=a,this.exifInfo={isValid:!1,status:"uninitialized"},this.setDataSource=function(a){this.dataSource=a},this.execute=function(a){this.getData(0,1023,this.parseHeader),this.onLoad=a},this.getData=function(a,b,c){this.req=new XMLHttpRequest,this.callback=c,this.req.open("GET",this.dataSource),this.req.overrideMimeType("text/plain; charset=x-user-defined"),this.req.setRequestHeader("Range","bytes="+a+"-"+b),this.req.onreadystatechange=hitch(this,"doCallback"),this.req.send(null)},this.doCallback=function(){if(4==this.req.readyState){if(stat=this.req.status,200!=stat&&206!=stat)return this.exifInfo.status="Request error; status code: "+this.req.status,this.onLoad(this.exifInfo),void 0;for(var a=this.req.responseText,b=new byteArray,c=0;c<a.length;c++){var d=a.charCodeAt(c);b.push(d>255?d-63232:d)}this.callback(b)}},this.parseHeader=function(a){var c,b=a.read16();if(b==SOI_MARKER)try{for(b=a.read16();b!=SOS_MARKER&&a.hasNext();){if(c=a.read16()-2,b==EXIF_MARKER){a.skipBytes(6);var d=a.getOffset();return this.getData(d,d+c-6,hitch(this,"parseExif")),void 0}a.skipBytes(c),b=a.read16()}}catch(e){this.exifInfo.status="Format error; no valid EXIF data found",this.onLoad(this.exifInfo)}else this.exifInfo.status="Format error; no JPEG header found",this.onLoad(this.exifInfo);this.exifInfo.status="Format error; no EXIF header found",this.onLoad(this.exifInfo)},this.parseExif=function(a){var b=a.read16();b==INTEL_BYTE_ORDER&&(a.swapBytes=!0);var c=a.read32(4);this.readExifDir(a,c),this.exifInfo.thumbOffset&&this.exifInfo.thumbLength?(this.exifInfo.exifData=a,this.exifInfo.isValid=!0):this.exifInfo.status="Exif error; no thumbnail found",this.onLoad(this.exifInfo)},this.readExifDir=function(a,b){try{for(var d,c=a.read16(b),e=0;c>e;e++){d=b+2+12*e;var f=a.read16(d);switch(f){case TAG_THUMBNAIL_OFFSET:this.exifInfo.thumbOffset=this.readTag(a,d);break;case TAG_THUMBNAIL_LENGTH:this.exifInfo.thumbLength=this.readTag(a,d);break;case TAG_DATETIME:this.exifInfo.dateTime=this.readTag(a,d);break;case TAG_MAKE:this.exifInfo.cameraMake=this.readTag(a,d);break;case TAG_MODEL:this.exifInfo.cameraModel=this.readTag(a,d)}}}catch(g){return this.exifInfo.status=g.toString(),void 0}if(d=b+2+12*c,d<a.getLength()-4){var h=a.read32(d);h&&this.readExifDir(a,h)}},this.readTag=function(a,b){var g,c=[0,1,1,2,4,8,1,1,2,4,8,4,8],d=a.read16(2+b),e=a.read32(4+b),f=e*c[d];return g=4>=f?b+8:a.read32(b+8),a.exifFormat(d,g,f)}}function byteArray(a){this.arr=a||[],this.hex="0 1 2 3 4 5 6 7 8 9 a b c d e f".split(/\s/),this.pos=0,this.swapBytes=!1,this.push=function(a){this.arr.push(a)},this.getLength=function(){return this.arr.length},this.hasNext=function(){return this.pos<this.arr.length-1},this.next=function(){return this.hasNext()?this.arr[this.pos++]:null},this.read16=function(a){this._check(2),a||(a=this.pos,this.pos+=2);var b=this.arr[a],c=this.arr[a+1];return this.swapBytes?c<<8|b:b<<8|c},this.read32=function(a){var b=this.arr;return this.swapBytes?b[a]|b[a+1]<<8|b[a+2]<<16|b[a+3]<<24:b[a]<<24|b[a+1]<<16|b[a+2]<<8|b[a+3]},this.skipBytes=function(a){this._check(a),this.pos+=a},this._check=function(a){if(this.pos+a>this.arr.length)throw new ExifException("Attempt to read past array index")},this.getOffset=function(){return this.pos},this.toString=function(a,b){a||(a=0),b||(b=this.arr.length);for(var c="",d=a;a+b>d;d++)0!=this.arr[d]&&(c+=String.fromCharCode(this.arr[d]));return c},this.toHexString=function(a,b){a||(a=0),b||(b=this.arr.length);for(var c="",d=a;a+b>d;d++)c+="%",c+=this.hex[Math.floor(this.arr[d]/16)],c+=this.hex[Math.floor(this.arr[d]%16)];return c},this.exifFormat=function(a,b,c){var d=this.arr;switch(a){case FMT_STRING:case FMT_UNDEFINED:return this.toString(b,c);case FMT_SBYTE:return d.charCodeAt(b);case FMT_BYTE:return d.charCodeAt(b);case FMT_USHORT:return this.read16(b);case FMT_ULONG:return this.read32(b);case FMT_URATIONAL:case FMT_SRATIONAL:var e,f;return e=this.read32(b),f=this.read32(b+4),0==f?0:e/f;case FMT_SSHORT:return this.read16(b);case FMT_SLONG:return this.read32(b);case FMT_SINGLE:case FMT_DOUBLE:return 0}return 0}}const SOI_MARKER=65496,SOS_MARKER=65498,EXIF_MARKER=65505,INTEL_BYTE_ORDER=18761,TAG_THUMBNAIL_OFFSET=513,TAG_THUMBNAIL_LENGTH=514,TAG_DATETIME=306,TAG_MAKE=271,TAG_MODEL=272,FMT_BYTE=1,FMT_STRING=2,FMT_USHORT=3,FMT_ULONG=4,FMT_URATIONAL=5,FMT_SBYTE=6,FMT_UNDEFINED=7,FMT_SSHORT=8,FMT_SLONG=9,FMT_SRATIONAL=10,FMT_SINGLE=11,FMT_DOUBLE=12;